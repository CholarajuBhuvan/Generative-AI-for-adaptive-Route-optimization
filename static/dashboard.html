<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Route Optimization Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        #map {
            height: 500px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .results {
            grid-column: 1 / -1;
        }

        .route-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .info-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .info-card .value {
            font-size: 2rem;
            font-weight: bold;
        }

        .info-card .unit {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .alternatives {
            margin-top: 30px;
        }

        .alternative-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .alternative-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .alternative-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .alternative-title {
            font-weight: bold;
            color: #4a5568;
        }

        .confidence-badge {
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .alternative-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #718096;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background-color: #48bb78;
        }

        .status-offline {
            background-color: #f56565;
        }

        .websocket-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
        }

        .preferences-panel {
            margin-top: 20px;
        }

        .preference-slider {
            margin-bottom: 15px;
        }

        .preference-slider label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .preference-slider input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
        }

        .preference-slider input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }

        .preference-slider input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .route-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Route Optimization</h1>
            <p>Advanced AI-powered route optimization with real-time traffic analysis</p>
        </div>

        <div class="websocket-status">
            <span class="status-indicator status-offline" id="ws-status"></span>
            <span id="ws-text">Connecting...</span>
        </div>

        <div class="main-content">
            <div class="panel">
                <h2>üìç Route Planning</h2>
                <form id="route-form">
                    <div class="form-group">
                        <label>Start Location</label>
                        <div class="form-row">
                            <input type="number" id="start-lat" placeholder="Latitude" step="0.000001" value="40.7128">
                            <input type="number" id="start-lng" placeholder="Longitude" step="0.000001" value="-74.0060">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>End Location</label>
                        <div class="form-row">
                            <input type="number" id="end-lat" placeholder="Latitude" step="0.000001" value="40.7589">
                            <input type="number" id="end-lng" placeholder="Longitude" step="0.000001" value="-73.9851">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Travel Mode</label>
                        <select id="travel-mode">
                            <option value="driving">üöó Driving</option>
                            <option value="walking">üö∂ Walking</option>
                            <option value="cycling">üö¥ Cycling</option>
                            <option value="transit">üöå Public Transit</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Route Constraints</label>
                        <div class="form-row">
                            <input type="number" id="max-time" placeholder="Max Time (min)" value="60">
                            <input type="number" id="max-distance" placeholder="Max Distance (km)" value="50">
                        </div>
                    </div>

                    <div class="preferences-panel">
                        <h3>üéØ Optimization Preferences</h3>
                        <div class="preference-slider">
                            <label>
                                <span>Time Priority</span>
                                <span id="time-value">40%</span>
                            </label>
                            <input type="range" id="time-weight" min="0" max="100" value="40">
                        </div>
                        <div class="preference-slider">
                            <label>
                                <span>Distance Priority</span>
                                <span id="distance-value">30%</span>
                            </label>
                            <input type="range" id="distance-weight" min="0" max="100" value="30">
                        </div>
                        <div class="preference-slider">
                            <label>
                                <span>Cost Priority</span>
                                <span id="cost-value">20%</span>
                            </label>
                            <input type="range" id="cost-weight" min="0" max="100" value="20">
                        </div>
                        <div class="preference-slider">
                            <label>
                                <span>Traffic Avoidance</span>
                                <span id="traffic-value">10%</span>
                            </label>
                            <input type="range" id="traffic-weight" min="0" max="100" value="10">
                        </div>
                    </div>

                    <button type="submit" class="btn" id="optimize-btn">
                        üöÄ Optimize Route
                    </button>
                </form>
            </div>

            <div class="panel">
                <h2>üó∫Ô∏è Route Visualization</h2>
                <div id="map"></div>
            </div>
        </div>

        <div class="panel results" id="results-panel" style="display: none;">
            <h2>üìä Optimization Results</h2>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>AI is optimizing your route...</p>
            </div>

            <div id="route-results">
                <div class="route-info" id="route-info"></div>
                
                <div class="alternatives" id="alternatives"></div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let routeLayer;
        let markers = [];
        let websocket;
        let currentRoute = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            initializeWebSocket();
            setupEventListeners();
            updatePreferenceSliders();
        });

        // Initialize map
        function initializeMap() {
            map = L.map('map').setView([40.7128, -74.0060], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            routeLayer = L.layerGroup().addTo(map);
        }

        // Initialize WebSocket connection
        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/live-updates`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function() {
                updateWebSocketStatus(true);
                websocket.send(JSON.stringify({
                    type: 'subscribe',
                    topic: 'route_updates'
                }));
            };
            
            websocket.onclose = function() {
                updateWebSocketStatus(false);
                // Reconnect after 3 seconds
                setTimeout(initializeWebSocket, 3000);
            };
            
            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
        }

        // Update WebSocket status indicator
        function updateWebSocketStatus(connected) {
            const statusIndicator = document.getElementById('ws-status');
            const statusText = document.getElementById('ws-text');
            
            if (connected) {
                statusIndicator.className = 'status-indicator status-online';
                statusText.textContent = 'Connected';
            } else {
                statusIndicator.className = 'status-indicator status-offline';
                statusText.textContent = 'Disconnected';
            }
        }

        // Handle WebSocket messages
        function handleWebSocketMessage(data) {
            if (data.type === 'route_update') {
                console.log('Route update received:', data);
                // Handle real-time route updates
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Route form submission
            document.getElementById('route-form').addEventListener('submit', handleRouteOptimization);
            
            // Preference sliders
            const sliders = ['time-weight', 'distance-weight', 'cost-weight', 'traffic-weight'];
            sliders.forEach(sliderId => {
                document.getElementById(sliderId).addEventListener('input', updatePreferenceSliders);
            });
        }

        // Update preference slider values
        function updatePreferenceSliders() {
            const sliders = ['time-weight', 'distance-weight', 'cost-weight', 'traffic-weight'];
            const values = ['time-value', 'distance-value', 'cost-value', 'traffic-value'];
            
            sliders.forEach((sliderId, index) => {
                const slider = document.getElementById(sliderId);
                const valueSpan = document.getElementById(values[index]);
                valueSpan.textContent = slider.value + '%';
            });
        }

        // Handle route optimization
        async function handleRouteOptimization(event) {
            event.preventDefault();
            
            const formData = {
                start_lat: parseFloat(document.getElementById('start-lat').value),
                start_lng: parseFloat(document.getElementById('start-lng').value),
                end_lat: parseFloat(document.getElementById('end-lat').value),
                end_lng: parseFloat(document.getElementById('end-lng').value),
                travel_mode: document.getElementById('travel-mode').value,
                constraints: {
                    max_time: parseInt(document.getElementById('max-time').value),
                    max_distance: parseInt(document.getElementById('max-distance').value)
                },
                user_preferences: {
                    time_weight: parseInt(document.getElementById('time-weight').value) / 100,
                    distance_weight: parseInt(document.getElementById('distance-weight').value) / 100,
                    cost_weight: parseInt(document.getElementById('cost-weight').value) / 100,
                    traffic_weight: parseInt(document.getElementById('traffic-weight').value) / 100
                },
                user_id: 'demo_user'
            };

            try {
                // Show loading state
                showLoading(true);
                showResults(true);

                // Add markers to map
                addMarkersToMap(formData.start_lat, formData.start_lng, formData.end_lat, formData.end_lng);

                // Call API
                const response = await fetch('/api/v1/optimize-route', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                currentRoute = result;

                // Display results
                displayRouteResults(result);
                drawRouteOnMap(result.coordinates);

            } catch (error) {
                console.error('Error optimizing route:', error);
                showError('Failed to optimize route. Please try again.');
            } finally {
                showLoading(false);
            }
        }

        // Add markers to map
        function addMarkersToMap(startLat, startLng, endLat, endLng) {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Add start marker
            const startMarker = L.marker([startLat, startLng])
                .addTo(map)
                .bindPopup('<b>Start Location</b>');
            markers.push(startMarker);

            // Add end marker
            const endMarker = L.marker([endLat, endLng])
                .addTo(map)
                .bindPopup('<b>End Location</b>');
            markers.push(endMarker);

            // Fit map to show both markers
            const group = new L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.1));
        }

        // Draw route on map
        function drawRouteOnMap(coordinates) {
            // Clear existing route
            routeLayer.clearLayers();

            // Convert coordinates to Leaflet format
            const routePoints = coordinates.map(coord => [coord.lat, coord.lng]);

            // Draw route line
            const routeLine = L.polyline(routePoints, {
                color: '#667eea',
                weight: 4,
                opacity: 0.8
            }).addTo(routeLayer);

            // Add waypoint markers
            coordinates.forEach((coord, index) => {
                if (index > 0 && index < coordinates.length - 1) {
                    const waypoint = L.circleMarker([coord.lat, coord.lng], {
                        radius: 5,
                        fillColor: '#667eea',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(routeLayer);
                    
                    waypoint.bindPopup(`Waypoint ${index}<br>Time: ${coord.time?.toFixed(1) || 'N/A'} min`);
                }
            });
        }

        // Display route results
        function displayRouteResults(result) {
            // Route info cards
            const routeInfo = document.getElementById('route-info');
            routeInfo.innerHTML = `
                <div class="info-card">
                    <h3>Distance</h3>
                    <div class="value">${result.total_distance_km.toFixed(1)}</div>
                    <div class="unit">kilometers</div>
                </div>
                <div class="info-card">
                    <h3>Duration</h3>
                    <div class="value">${result.total_time_minutes.toFixed(0)}</div>
                    <div class="unit">minutes</div>
                </div>
                <div class="info-card">
                    <h3>Cost</h3>
                    <div class="value">$${result.total_cost.toFixed(2)}</div>
                    <div class="unit">estimated</div>
                </div>
                <div class="info-card">
                    <h3>Confidence</h3>
                    <div class="value">${(result.confidence_score * 100).toFixed(0)}%</div>
                    <div class="unit">AI confidence</div>
                </div>
                <div class="info-card">
                    <h3>AI Model</h3>
                    <div class="value">${result.ai_model_used}</div>
                    <div class="unit">used</div>
                </div>
            `;

            // Traffic analysis
            if (result.traffic_analysis && result.traffic_analysis.overall_metrics) {
                const trafficCard = document.createElement('div');
                trafficCard.className = 'info-card';
                trafficCard.innerHTML = `
                    <h3>Traffic Level</h3>
                    <div class="value">${(result.traffic_analysis.overall_metrics.average_traffic_level * 100).toFixed(0)}%</div>
                    <div class="unit">average</div>
                `;
                routeInfo.appendChild(trafficCard);
            }

            // Alternatives
            displayAlternatives(result.alternatives);
        }

        // Display route alternatives
        function displayAlternatives(alternatives) {
            const alternativesContainer = document.getElementById('alternatives');
            
            if (!alternatives || alternatives.length === 0) {
                alternativesContainer.innerHTML = '<p>No alternatives available</p>';
                return;
            }

            alternativesContainer.innerHTML = '<h3>üîÑ Alternative Routes</h3>';
            
            alternatives.forEach((alt, index) => {
                const altCard = document.createElement('div');
                altCard.className = 'alternative-card';
                altCard.innerHTML = `
                    <div class="alternative-header">
                        <div class="alternative-title">Alternative ${index + 1} (${alt.model_used})</div>
                        <div class="confidence-badge">${(alt.confidence_score * 100).toFixed(0)}% confidence</div>
                    </div>
                    <div class="alternative-stats">
                        <div class="stat-item">
                            <div class="stat-value">${alt.total_distance_km.toFixed(1)}</div>
                            <div class="stat-label">Distance (km)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${alt.total_time_minutes.toFixed(0)}</div>
                            <div class="stat-label">Time (min)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${alt.coordinates.length}</div>
                            <div class="stat-label">Waypoints</div>
                        </div>
                    </div>
                `;
                
                // Add click handler to show alternative on map
                altCard.addEventListener('click', () => {
                    drawRouteOnMap(alt.coordinates);
                });
                
                alternativesContainer.appendChild(altCard);
            });
        }

        // Show/hide loading state
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('route-results').style.display = show ? 'none' : 'block';
            document.getElementById('optimize-btn').disabled = show;
        }

        // Show/hide results panel
        function showResults(show) {
            document.getElementById('results-panel').style.display = show ? 'block' : 'none';
            if (show) {
                document.getElementById('results-panel').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Show error message
        function showError(message) {
            const resultsPanel = document.getElementById('results-panel');
            resultsPanel.innerHTML = `
                <div class="panel">
                    <h2>‚ùå Error</h2>
                    <p>${message}</p>
                </div>
            `;
            showResults(true);
        }

        // Handle feedback submission
        async function submitFeedback(rating, feedbackType, comments = '') {
            if (!currentRoute) return;

            try {
                const response = await fetch('/api/v1/feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        route_id: currentRoute.route_id,
                        user_id: 'demo_user',
                        rating: rating,
                        feedback_type: feedbackType,
                        comments: comments
                    })
                });

                if (response.ok) {
                    console.log('Feedback submitted successfully');
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
            }
        }

        // Add feedback buttons to the page (optional)
        function addFeedbackButtons() {
            const feedbackPanel = document.createElement('div');
            feedbackPanel.className = 'panel';
            feedbackPanel.innerHTML = `
                <h2>üí¨ Rate This Route</h2>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn" onclick="submitFeedback(5, 'route_quality', 'Excellent route!')" style="width: auto; padding: 10px 20px;">üëç Great</button>
                    <button class="btn" onclick="submitFeedback(3, 'route_quality', 'Average route')" style="width: auto; padding: 10px 20px;">üëå OK</button>
                    <button class="btn" onclick="submitFeedback(1, 'route_quality', 'Poor route')" style="width: auto; padding: 10px 20px;">üëé Poor</button>
                </div>
            `;
            
            document.querySelector('.container').appendChild(feedbackPanel);
        }
    </script>
</body>
</html>
